<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: layers/geometry/SolrGeometryHistoryLayer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: layers/geometry/SolrGeometryHistoryLayer.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>require("./GeometryLayer.js");
require("../../providers/SolrHistoryProvider.js");


/**
 * Base class for layers using a Solr provider to get the features
 *
 * @class
 * @abstract
 * @extends SMC.layers.geometry.GeometryLayer
 * @mixes SMC.providers.SolrHistoryProvider
 *
 */
SMC.layers.geometry.SolrGeometryHistoryLayer = SMC.layers.geometry.GeometryLayer.extend(
    /** @lends SMC.layers.geometry.SolrGeometryHistoryLayer# */
    {
        _historyLayers: {},
        _timer: null,
        _node: null,
        

        /**
         * Initialize the object with the params
         * @param {object} options - object with need parameters
         */
        initialize: function(options) {
           
            SMC.layers.geometry.GeometryLayer.prototype.initialize.call(this, options);
            SMC.providers.SolrHistoryProvider.prototype.initialize.call(this, options);
            L.Util.setOptions(this, options);
            this.setZIndex(1000);

             
        },



        /**
         * Method to load the features
         */
        load: function() {
           

        },
      
        /**
         * Method to create an HTML node for the layer.
         * @returns {String} HTML code representing the code to be added to the layer's entry in the layer tree.
         */
        createNodeHTML: function(){

            var node = document.createElement("div");
            node.id = "node_" + this._leaflet_id;
            
            var label = document.createElement('span'),
                input,
                checked = this.getMap().hasLayer(this);

            input = document.createElement('input');
            input.type = 'checkbox';
            input.defaultChecked = checked;
            input.style.cursor = "pointer";
            var name = document.createElement('span');
            name.innerHTML = ' ' + (this.options.label || this.options.typeName);

            label.appendChild(input);
            label.appendChild(name);
            node.appendChild(label);
            if($.isEmptyObject(this._featuresForLayer)){
              return node;
             }

            var sliderControl = document.createElement("table");
            sliderControl.style.marginLeft = '10px';
            sliderControl.style.marginTop = '5px';
            sliderControl.className = 'leaflet-bar leaflet-update-interval ';

            var sliderControlLabel = document.createElement("span");
            sliderControlLabel.style.float = 'left';
            sliderControl.style.font = '12px/1.5 "Helvetica Neue", Arial, Helvetica, sans-serif';

            var inputInterval = document.createElement('input');
            inputInterval.type = 'range';
            inputInterval.id = "interval_" + this._leaflet_id;
            inputInterval.name = "interval_" + this._leaflet_id;
            inputInterval.min = 0;
            inputInterval.max = Object.keys(this._featuresForLayer).length - 1;
            inputInterval.step = 1;
            inputInterval.value = 0;
            //sliderControl.innerHTML += '&lt;input id="interval_' + this._leaflet_id + '" name="interval_' + this._leaflet_id + '" min="0" max="' + (Object.keys(this._featuresForLayer).length - 1) + '" type="range" step="1" value="0"/>';
           

            var time = inputInterval.value;

            var play_pause = document.createElement("i"); 
            play_pause.className = 'fa fa-play';
            play_pause.style.cursor = "pointer";

            this._addTimeData(time);
            this._showLabel(sliderControlLabel);

            var self = this;
            L.DomEvent.addListener(inputInterval, 'mousedown', L.DomEvent.stopPropagation);
            L.DomEvent.addListener(inputInterval, 'mouseup', function() {
                time = inputInterval.value;
                self.showTimeData(time);
                self._showLabel(sliderControlLabel);
                L.DomEvent.stopPropagation;
            });
            L.DomEvent.addListener(inputInterval, 'touchstart', L.DomEvent.stopPropagation);
            L.DomEvent.addListener(inputInterval, 'touchend', L.DomEvent.stopPropagation);

            var tr = document.createElement('tr');
            var td1 = document.createElement('td');
            var td2 = document.createElement('td');
            var td3 = document.createElement('td');
            td1.appendChild(sliderControlLabel);
            td2.appendChild(play_pause);
            td3.appendChild(inputInterval);
            tr.appendChild(td1);
            tr.appendChild(td2);
            tr.appendChild(td3);

            sliderControl.appendChild(tr);
           
            
            node.appendChild(sliderControl);

            play_pause.onclick = function() {
                self._onPlayPause(node, time);
            };
            label.onchange = function(event) {
                self._clickOnLayer(node);
            };
            this._node = node;
            return node;

        },
     
        /**
         * Method to get the map
         * @returns {SMC.Map} map - Map layer
         */
        getMap: function() {
           if (this.parent) {
                if (this.parent.map) {
                    map = this.parent.map;
                } else if (this.parent._map) {
                    map = this.parent._map;
                }
                 else if (this.parent.parent) {
                    if (this.parent.parent.map)
                        map = this.parent.parent.map;
                    else if (this.parent.parent._map)
                        map = this.parent.parent._map;
                }

                return map;
            }
            else if(this._map){
                map = this._map;
                return map;
            }

        },

       
         /**
         * Method to change the set of features for the layer
         */
        showTimeData: function(time) {
            var i = 0;
            var data = this._featuresForLayer;
            if (time % 1 !== 0) {
                time = time - (time % 1);
            }

            for (var d in data) {
                if (data[d].actual) { 
                    data[d].actual = false;
                }
                if (i == time) {
                    if (!data[d].actual) {
                        
                        data[d].actual = true;
                        this.features = [];
                        if(data[d].lastZoom &amp;&amp; (data[d].lastZoom != this.getMap().getZoom())){
                            for(var f in data[d]){
                                data[d][f]._clean = false;
                            }
                        }
                        this.addGeometryFromFeatures(data[d]);
                        data[d].lastZoom = this.getMap().getZoom();
                        //recalculate canvas position for geometry layers (important)
                        this.getMap().fire("slidermove");
                    }

                }

                i++;

            }

        },

        _addTimeData: function(time) {
         var i = 0;
            var data = this._featuresForLayer;
            for (var d in data) {
                if (i == time) {
                    this.addGeometryFromFeatures(data[d]);
                    data[d].actual = true;
                }
               
                i++;

            }

        },

        _showLabel: function(sliderControlLabel) {
          var data = this._featuresForLayer;
            for (var d in data) {
                if (data[d].actual) {
                    sliderControlLabel.innerHTML = d;
                }
            }
        },

        _clickOnLayer: function(node) {
           var pause = node.getElementsByClassName('fa fa-pause')[0];
            if (pause) {
                this._onPlayPause(node);
            }
            var data = this._featuresForLayer;
            if (node.children[1].style.display != 'none') {
                node.children[1].style.display = 'none';
                node.children[0].checked = false;
                for (var d in data) {
                    if (data[d].actual) { 
                        this.onRemove(this.getMap());
                    }
                }
            } else {
                node.children[1].style.display = 'block';
                node.children[0].checked = true;
                for (var d in data) {
                    if (data[d].actual) {
                        this.onAdd(this.getMap());
                        this.addGeometryFromFeatures(data[d]);

                    }
                }
            }

        },

        _onPlayPause: function(node, time) {
           var data = this._featuresForLayer;
           var slider = node.children[1].children[0].children[2].children[0];
           var maxValue = slider.max;
           var sliderControlLabel = node.children[1].children[0].children[0].children[0];
           var play = node.children[1].children[0].children[1].children[0];

            if (play.className == 'fa fa-play') {
                play.className = 'fa fa-pause';
                if (slider.value == maxValue) {
                   slider.value = 0;
                }


                var i = parseFloat(slider.value);
                var self = this;
                this._timer = setInterval(function() {
                    
                    self.showTimeData(i);
                    self._showLabel(sliderControlLabel);
                    if (i &lt; maxValue) {
                        slider.value = i;

                    } else {
                        clearInterval(self._timer);
                        play.className = 'fa fa-play';
                        slider.value = maxValue;

                    }
                    i += parseFloat(slider.step);

                }, this.options.time);

            } else {

                play.className = 'fa fa-play';
                clearInterval(this._timer);
            }
        },


       
        
    }, [SMC.providers.SolrHistoryProvider]);

/**
 * API factory method for easy creation of Solr geometry history layer.
 * @params {Object} options - Options to initialize the Solr request 
 */
SMC.solrGeometryHistoryLayer = function(options) {
    return new SMC.layers.geometry.SolrGeometryHistoryLayer(options);
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="SMC.controls.layerTree.LayerTreeControl.html">LayerTreeControl</a></li><li><a href="SMC.controls.layerTree.LayerTreeLeaf.html">LayerTreeLeaf</a></li><li><a href="SMC.controls.layerTree.LayerTreeNode.html">LayerTreeNode</a></li><li><a href="SMC.layers.aggregation.AggregatingLayer.html">AggregatingLayer</a></li><li><a href="SMC.layers.aggregation.MultiModeLayer.html">MultiModeLayer</a></li><li><a href="SMC.layers.EditableLayer.html">EditableLayer</a></li><li><a href="SMC.layers.Folder.html">Folder</a></li><li><a href="SMC.layers.geometry.CanvasRenderer.html">CanvasRenderer</a></li><li><a href="SMC.layers.geometry.GeometryLayer.html">GeometryLayer</a></li><li><a href="SMC.layers.geometry.SolrGeometryHistoryLayer.html">SolrGeometryHistoryLayer</a></li><li><a href="SMC.layers.geometry.TiledGeometryLayer.html">TiledGeometryLayer</a></li><li><a href="SMC.layers.geometry.WFSGeometryLayer.html">WFSGeometryLayer</a></li><li><a href="SMC.layers.geometry.WFSTiledGeometryLayer.html">WFSTiledGeometryLayer</a></li><li><a href="SMC.layers.history.AggregatingHistoryLayer.html">AggregatingHistoryLayer</a></li><li><a href="SMC.layers.history.DataHistoryLayer.html">DataHistoryLayer</a></li><li><a href="SMC.layers.IsochroneLayer.html">IsochroneLayer</a></li><li><a href="SMC.layers.Layer.html">Layer</a></li><li><a href="SMC.layers.markers.AtmosphereRTMarkerLayer.html">AtmosphereRTMarkerLayer</a></li><li><a href="SMC.layers.markers.MarkerLayer.html">MarkerLayer</a></li><li><a href="SMC.layers.markers.WFSMarkerLayer.html">WFSMarkerLayer</a></li><li><a href="SMC.layers.markers.WFSTMarkerLayer.html">WFSTMarkerLayer</a></li><li><a href="SMC.layers.reloaders.AtmosphereRTReloadTrigger.html">AtmosphereRTReloadTrigger</a></li><li><a href="SMC.layers.reloaders.LayerReloader.html">LayerReloader</a></li><li><a href="SMC.layers.reloaders.ReloadTrigger.html">ReloadTrigger</a></li><li><a href="SMC.layers.reloaders.TimerReloadTrigger.html">TimerReloadTrigger</a></li><li><a href="SMC.layers.stylers.Styler.html">Styler</a></li><li><a href="SMC.layers.TileLayer.html">TileLayer</a></li><li><a href="SMC.layers.WMSLayer.html">WMSLayer</a></li><li><a href="SMC.Map.html">Map</a></li><li><a href="SMC.providers.AtmosphereConnector.html">AtmosphereConnector</a></li><li><a href="SMC.providers.AtmosphereRTFeatureProvider.html">AtmosphereRTFeatureProvider</a></li><li><a href="SMC.providers.FeatureHistory.html">FeatureHistory</a></li><li><a href="SMC.providers.FeatureHistoryProvider.html">FeatureHistoryProvider</a></li><li><a href="SMC.providers.FeaturesProvider.html">FeaturesProvider</a></li><li><a href="SMC.providers.RTFeatureProvider.html">RTFeatureProvider</a></li><li><a href="SMC.providers.SolrHistoryProvider.html">SolrHistoryProvider</a></li><li><a href="SMC.providers.URLFeatureProvider.html">URLFeatureProvider</a></li><li><a href="SMC.providers.WFSProvider.html">WFSProvider</a></li><li><a href="SMC.providers.WFSTProvider.html">WFSTProvider</a></li></ul><h3>Events</h3><ul><li><a href="SMC.layers.geometry.TiledGeometryLayer.html#event:layeradd">layeradd</a></li><li><a href="SMC.layers.geometry.WFSTiledGeometryLayer.html#event:layeradd">layeradd</a></li><li><a href="SMC.layers.reloaders.AtmosphereRTReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.layers.reloaders.ReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.layers.reloaders.TimerReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.providers.AtmosphereConnector.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.AtmosphereRTFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.FeatureHistoryProvider.html#event:featureHistoryLoaded">featureHistoryLoaded</a></li><li><a href="SMC.providers.FeaturesProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.RTFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.SolrHistoryProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.URLFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.WFSProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.WFSTProvider.html#event:featuresLoaded">featuresLoaded</a></li></ul><h3>Namespaces</h3><ul><li><a href="SMC.html">SMC</a></li><li><a href="SMC.controls.html">controls</a></li><li><a href="SMC.controls.layerTree.html">layerTree</a></li><li><a href="SMC.layers.html">layers</a></li><li><a href="SMC.layers.aggregation.html">aggregation</a></li><li><a href="SMC.layers.geometry.html">geometry</a></li><li><a href="SMC.layers.history.html">history</a></li><li><a href="SMC.layers.markers.html">markers</a></li><li><a href="SMC.layers.reloaders.html">reloaders</a></li><li><a href="SMC.layers.stylers.html">stylers</a></li><li><a href="SMC.providers.html">providers</a></li></ul><h3>Mixins</h3><ul><li><a href="SMC.controls.layerTree.LayerTreeFolder.html">LayerTreeFolder</a></li><li><a href="SMC.LayerLoader.html">LayerLoader</a></li><li><a href="SMC.layers.SingleLayer.html">SingleLayer</a></li><li><a href="SMC.layers.stylers.MapCssStyler.html">MapCssStyler</a></li><li><a href="SMC.layers.stylers.MarkerCssStyler.html">MarkerCssStyler</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Mustache">Mustache</a></li><li><a href="global.html#paper">paper</a></li><li><a href="global.html#PEG">PEG</a></li><li><a href="global.html#rbush">rbush</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Mon Nov 24 2014 08:51:38 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
