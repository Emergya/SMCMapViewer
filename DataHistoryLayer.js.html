<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: layers/history/DataHistoryLayer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: layers/history/DataHistoryLayer.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>require("./AggregatingHistoryLayer.js");
require("../layers.js");
require("../../LayerLoader.js");

/**
 * Class formed by the aggregation of several history layers.
 *
 * @class
 * @extends SMC.layers.SingleLayer
 *
 * @author Luis RomÃ¡n (lroman@emergya.com)
 */
SMC.layers.history.DataHistoryLayer = SMC.layers.SingleLayer.extend(
	/** @lends SMC.layers.history.DataHistoryLayer# */
	{
		_historyLayers: {},
		_timer: null,
		_node: null,

		 /**
         * Initialize the object with the params
         * @param {object} options - object with need parameters
         */
		initialize: function(options) {
			L.Util.setOptions(this, options);
			L.LayerGroup.prototype.initialize.call(this, options);
			SMC.layers.SingleLayer.prototype.initialize.apply(this, options);


		},

		/**
         * Method to create an HTML node for the name of the layer.
         * @returns {String} HTML code representing the code to be added to the layer's entry in the layer tree.
         */
		createNodeHTML: function() {
			this._historyLayers = this._orderLayers();
			var layers = this._historyLayers;

			var node = document.createElement("div");
			var label = document.createElement('label'),
				input,
				checked = this.getMap().hasLayer(this);

			input = document.createElement('input');
			input.type = 'checkbox';
			input.defaultChecked = checked;
			var name = document.createElement('span');
			name.innerHTML = ' ' + (this.options.label || this.options.typeName);

			label.appendChild(input);
			label.appendChild(name);

			label.style.cursor = "pointer";

			label.onchange = function(event) {
				self._clickOnLayer(node);
			};

			var sliderControl = document.createElement("div");
			sliderControl.style.marginLeft = '10px';
			sliderControl.style.marginTop = '5px';


			var sliderControlLabel = document.createElement("span");
			sliderControlLabel.style.float = 'left';
			sliderControl.innerHTML += '&lt;input id="interval_' + this._leaflet_id + '" name="interval_' + this._leaflet_id + '" min="0" max="' + (this.options.layersConfig.length - 1) + '" type="range" step="1" value="0"/>';
			sliderControl.className = 'leaflet-bar leaflet-update-interval ';

			var time = sliderControl.children[0].value;

			var play_pause = document.createElement("i");
			play_pause.style.float = 'left';
			play_pause.style.marginLeft = '10px';
			play_pause.style.marginTop = '5px';
			play_pause.className = 'fa fa-play';
			play_pause.style.cursor = "pointer";

			this._addTimeData(time);
			this._showLabel(sliderControlLabel);

			var self = this;
			L.DomEvent.addListener(sliderControl, 'mousedown', L.DomEvent.stopPropagation);
			L.DomEvent.addListener(sliderControl, 'mouseup', function() {
				time = sliderControl.children[0].value;
				self.showTimeData(time);
				self._showLabel(sliderControlLabel);
				L.DomEvent.stopPropagation;
			});
			L.DomEvent.addListener(sliderControl, 'touchstart', L.DomEvent.stopPropagation);
			L.DomEvent.addListener(sliderControl, 'touchend', L.DomEvent.stopPropagation);

			sliderControl.appendChild(sliderControlLabel);
			sliderControl.appendChild(play_pause);
			node.appendChild(label);
			node.appendChild(sliderControl);

			play_pause.onclick = function() {
				self._onPlayPause(node, time);
			};
			this._node = node;
			return node;

		},

		_orderLayers: function() {
			var layers;
			var exists = true;
			for (var d in this._aggregatingLayers) {
				var date = this._aggregatingLayers[d].options.date;
				if (!date) {
					exists = false;
					break;
				}
			}

			if (!exists) {
				layers = this._aggregatingLayers;

			} else {

				var layersObj = {};
				var layersArray = [];
				for (var l in this._aggregatingLayers) {
					layersArray.push(this._aggregatingLayers[l]);
				}

				layersArray.sort(function(a, b) {
					return (a.options.date - b.options.date)
				});

				for (var i = 0; i &lt; layersArray.length; i++) {
					if (!layersObj[layersArray[i].options.date]) {
						layersObj[layersArray[i].options.date] = layersArray[i];
					} else {
						layersObj[layersArray[i].options.label] = layersArray[i];
					}
				}
				layers = layersObj;
			}
			return layers;

		},


		 /**
         * Method to load the control in the map
         * @param {SMC.Map} map - Map to be added
         */
		addTo: function(map) {
			SMC.layers.aggregation.AggregatingLayer.prototype.addTo.call(this, map);
		},

		/**
         * Method to get the map
         * @returns {SMC.Map} map - Map layer
         */
		getMap: function() {
			SMC.layers.aggregation.AggregatingLayer.prototype.getMap.call(this, arguments);
			return map;
		},

		/**
         * Method to show the correct history layer
         * @param {string} time - Value of the slider control
         */
		showTimeData: function(time) {
			var i = 0;
			var data = this._historyLayers;
			if (time % 1 !== 0) {
				time = time - (time % 1);
			}
			for (var d in data) {
				// if (i == time &amp;&amp; data[d].actual) {
				// 	break;
				// }
				
					if (data[d].actual) {
							data[d].onRemove(this.getMap());
							data[d].actual = false;

					}

					if (i == time) {
						if (!data[d].actual) {
							data[d]._slidermove = true;
							data[d].actual = true;
							data[d].onAdd(this.getMap());

							//recalculate canvas position for geometry layers (important)
							this.getMap().fire("slidermove");
						}
					}

					i++;

				}
			

		},

		_addTimeData: function(time) {
			var i = 0;
			var data = this._historyLayers;
			for (var d in data) {

				if (i == time) {
					this.getMap().addLayer(data[d]);
					this._historyLayers[d].actual = true;
				}
				i++;

			}

		},

		_showLabel: function(sliderControlLabel) {
			var data = this._historyLayers;
			for (var d in data) {
				if (data[d].actual) {
					sliderControlLabel.innerHTML = data[d].options.label || data[d].options.typeName;
				}
			}
		},

		_clickOnLayer: function(node) {
			var pause = node.getElementsByClassName('fa fa-pause')[0];
			if (pause) {
				this._onPlayPause(node);
			}
			var data = this._historyLayers;
			if (node.children[1].style.display != 'none') {
				node.children[1].style.display = 'none';
				node.children[0].checked = false;
				for (var d in data) {
					if (data[d].actual) {
						data[d].onRemove(map);
					}
				}
			} else {
				node.children[1].style.display = 'block';
				node.children[0].checked = true;
				for (var d in data) {
					if (data[d].actual) {
						data[d].onAdd(map);
					}
				}
			}

		},

		_onPlayPause: function(node, time) {
			var data = this._historyLayers;

			var maxValue = node.children[1].children[0].max;
			var sliderControlLabel = node.children[1].children[1];

			if (node.children[1].children[2].className == 'fa fa-play') {
				node.children[1].children[2].className = 'fa fa-pause';
				if (node.children[1].children[0].value == maxValue) {
					node.children[1].children[0].value = 0;
				}


				var i = parseFloat(node.children[1].children[0].value);
				var self = this;
				this._timer = setInterval(function() {
					i += parseFloat(node.children[1].children[0].step);
					self.showTimeData(i);
					self._showLabel(sliderControlLabel);
					if (i &lt; maxValue) {
						node.children[1].children[0].value = i;

					} else {
						clearInterval(self._timer);
						node.children[1].children[2].className = 'fa fa-play';
						node.children[1].children[0].value = maxValue;

					}

				}, this.options.time);

			} else {

				node.children[1].children[2].className = 'fa fa-play';
				clearInterval(this._timer);
			}
		},

		 /**
         * Method to remove the control in the map
         * @param {SMC.Map} map - Map to be removed
         */
		onRemove: function(map) {
			var data = this._historyLayers;
			for (var d in data) {
				if (data[d].actual) {
					data[d]._slidermove = false;
					data[d].onRemove(map);

				}

			}

		},

 		/**
         * Method to load the control in the map
         * @param {SMC.Map} map - Map to be added
         */
		onAdd: function(map) {
			SMC.layers.aggregation.AggregatingLayer.prototype.addTo.call(this, map);
			var value;
			if (this._node != null) {
				value = this._node.children[1].children[0].value;
			} else
				value = 0;

			var data = this._historyLayers;
			for (var d in data) {
				if (data[d].actual) {
					data[d]._slidermove = false;
					data[d].onAdd(map);

				}
			}

		

		}



	});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="SMC.controls.layerTree.LayerTreeControl.html">LayerTreeControl</a></li><li><a href="SMC.controls.layerTree.LayerTreeLeaf.html">LayerTreeLeaf</a></li><li><a href="SMC.controls.layerTree.LayerTreeNode.html">LayerTreeNode</a></li><li><a href="SMC.layers.aggregation.AggregatingLayer.html">AggregatingLayer</a></li><li><a href="SMC.layers.aggregation.MultiModeLayer.html">MultiModeLayer</a></li><li><a href="SMC.layers.EditableLayer.html">EditableLayer</a></li><li><a href="SMC.layers.Folder.html">Folder</a></li><li><a href="SMC.layers.geometry.CanvasRenderer.html">CanvasRenderer</a></li><li><a href="SMC.layers.geometry.GeometryLayer.html">GeometryLayer</a></li><li><a href="SMC.layers.geometry.TiledGeometryLayer.html">TiledGeometryLayer</a></li><li><a href="SMC.layers.geometry.WFSGeometryLayer.html">WFSGeometryLayer</a></li><li><a href="SMC.layers.geometry.WFSTiledGeometryLayer.html">WFSTiledGeometryLayer</a></li><li><a href="SMC.layers.history.AggregatingHistoryLayer.html">AggregatingHistoryLayer</a></li><li><a href="SMC.layers.history.DataHistoryLayer.html">DataHistoryLayer</a></li><li><a href="SMC.layers.Layer.html">Layer</a></li><li><a href="SMC.layers.markers.AtmosphereRTMarkerLayer.html">AtmosphereRTMarkerLayer</a></li><li><a href="SMC.layers.markers.MarkerLayer.html">MarkerLayer</a></li><li><a href="SMC.layers.markers.WFSMarkerLayer.html">WFSMarkerLayer</a></li><li><a href="SMC.layers.markers.WFSTMarkerLayer.html">WFSTMarkerLayer</a></li><li><a href="SMC.layers.reloaders.AtmosphereRTReloadTrigger.html">AtmosphereRTReloadTrigger</a></li><li><a href="SMC.layers.reloaders.LayerReloader.html">LayerReloader</a></li><li><a href="SMC.layers.reloaders.ReloadTrigger.html">ReloadTrigger</a></li><li><a href="SMC.layers.reloaders.TimerReloadTrigger.html">TimerReloadTrigger</a></li><li><a href="SMC.layers.stylers.Styler.html">Styler</a></li><li><a href="SMC.layers.TileLayer.html">TileLayer</a></li><li><a href="SMC.layers.WMSLayer.html">WMSLayer</a></li><li><a href="SMC.Map.html">Map</a></li><li><a href="SMC.providers.AtmosphereConnector.html">AtmosphereConnector</a></li><li><a href="SMC.providers.AtmosphereRTFeatureProvider.html">AtmosphereRTFeatureProvider</a></li><li><a href="SMC.providers.FeatureHistory.html">FeatureHistory</a></li><li><a href="SMC.providers.FeatureHistoryProvider.html">FeatureHistoryProvider</a></li><li><a href="SMC.providers.FeaturesProvider.html">FeaturesProvider</a></li><li><a href="SMC.providers.RTFeatureProvider.html">RTFeatureProvider</a></li><li><a href="SMC.providers.URLFeatureProvider.html">URLFeatureProvider</a></li><li><a href="SMC.providers.WFSProvider.html">WFSProvider</a></li><li><a href="SMC.providers.WFSTProvider.html">WFSTProvider</a></li></ul><h3>Events</h3><ul><li><a href="SMC.layers.geometry.TiledGeometryLayer.html#event:layeradd">layeradd</a></li><li><a href="SMC.layers.geometry.WFSTiledGeometryLayer.html#event:layeradd">layeradd</a></li><li><a href="SMC.layers.reloaders.AtmosphereRTReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.layers.reloaders.ReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.layers.reloaders.TimerReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.providers.AtmosphereConnector.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.AtmosphereRTFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.FeatureHistoryProvider.html#event:featureHistoryLoaded">featureHistoryLoaded</a></li><li><a href="SMC.providers.FeaturesProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.RTFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.URLFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.WFSProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.WFSTProvider.html#event:featuresLoaded">featuresLoaded</a></li></ul><h3>Namespaces</h3><ul><li><a href="SMC.html">SMC</a></li><li><a href="SMC.controls.html">controls</a></li><li><a href="SMC.controls.layerTree.html">layerTree</a></li><li><a href="SMC.layers.html">layers</a></li><li><a href="SMC.layers.aggregation.html">aggregation</a></li><li><a href="SMC.layers.geometry.html">geometry</a></li><li><a href="SMC.layers.history.html">history</a></li><li><a href="SMC.layers.markers.html">markers</a></li><li><a href="SMC.layers.reloaders.html">reloaders</a></li><li><a href="SMC.layers.stylers.html">stylers</a></li><li><a href="SMC.providers.html">providers</a></li></ul><h3>Mixins</h3><ul><li><a href="SMC.controls.layerTree.LayerTreeFolder.html">LayerTreeFolder</a></li><li><a href="SMC.LayerLoader.html">LayerLoader</a></li><li><a href="SMC.layers.SingleLayer.html">SingleLayer</a></li><li><a href="SMC.layers.stylers.MapCssStyler.html">MapCssStyler</a></li><li><a href="SMC.layers.stylers.MarkerCssStyler.html">MarkerCssStyler</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Mustache">Mustache</a></li><li><a href="global.html#paper">paper</a></li><li><a href="global.html#PEG">PEG</a></li><li><a href="global.html#rbush">rbush</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Thu Sep 11 2014 11:44:42 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
