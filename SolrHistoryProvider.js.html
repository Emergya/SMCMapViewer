<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: providers/SolrHistoryProvider.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: providers/SolrHistoryProvider.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>require("./URLFeatureProvider.js");


/**
 * Base class to create a Solr provider
 * @class
 * @extends SMC.providers.URLFeatureProvider
 * @mixes L.Mixin.Events
 * @param {SMC.providers.SolrHistoryProvider~options} options - The configuration for the class
 *
 */
SMC.providers.SolrHistoryProvider = SMC.providers.URLFeatureProvider.extend(
    /** @lends SMC.providers.SolrHistoryProvider# */
    {
        _featuresForLayer: {},
        features: [],
       /**
        * @typedef {Object} SMC.providers.SolrHistoryProvider~options
        * @property {SMC.providers.SolrHistoryProvider~requestParams} requestParams - Default solr request parameters
        * @property {string} serverURL=null - The solr server url path parameter
        * @property {string} timeField='time' - The field for define history layers
        * @property {string} geomField='location' - The geometry field 
        * @property {string} time=500 - Time for slider in milliseconds 
        */
        options: {
            /** @typedef {Object} SMC.providers.SolrHistoryProvider~requestParams - Default solr request parameters
             * @property {string} q="*:*" - Main query for the request
             * @property {string} fq=null - Filter query that will be used to restrict the set of documents that will be returned
             * @property {string} sort=null - Order for the returned documents
             * @property {string} fl=null - Parameter for to specify a set of fields to return
             * @property {string} df=null - Parameter that override the default field defined in Solr schema xml
             * @property {string} rows=null - Parameter for specify the maximun number of documents returned
             * @property {string} wt='json' - Default solr output format parameter
             * @property {string} indent=true - Default indenting the response      
             */
            requestParams:{
               q:'*:*',
               fq:null,
               sort: null,
               fl: null,
               df: null,
               rows: null,
               wt: 'json',
               indent: true,
              
              
            },
            serverURL: null,
            timeField: 'time',
            geomField: 'location',
            time: 500
            
            
        },
        /**
         * Initialize the class with options parameter
         * @param {object} options - default options
         */
        initialize: function(options) {
            L.Util.setOptions(this, options);
        },
        /**
         * Send Solr request to get the group layers
         */
        doFeaturesLoading: function() {
        	
            var self = this;

       
            $.ajax({
                url: this.options.serverURL + "?json.wrf=?&amp;group=true&amp;group.field=" + this.options.timeField,
                data: this.getParamsFromOptions(),
                dataType:'jsonp',
                success: function(result){
                   var numRows = result.grouped[self.options.timeField].matches;
                   var values = [];
                   var groups =result.grouped[self.options.timeField].groups;
                   for(var i in groups){
                        values.push(groups[i].groupValue);
                        //self._aggregatingLayers[groups[i].groupValue] = new SMC.layers.geometry.GeometryLayer(self.options);
                   }

                   self.doLayersGroupLoading(numRows, values);
          
                }
            });
            
        },

        /**
         * Get params from options attributes
         * @returns {object} Object with the Solr params to send
         */
        getParamsFromOptions: function() {
            var params = {};
            for (var option in this.options.requestParams) {
                
                if(this.options[option]){
                     params[option] = this.options[option];
                }
                else if (this.options.requestParams[option] !== null){
                    params[option] = this.options.requestParams[option];
                }
                

            }
            return params;
        },
        /**
         * Send Solr request to get the features
         */
        doLayersGroupLoading:function(rows, values){
            var self = this; 
            this.options.requestParams.rows = rows;
            var allFeatures = [];
             $.ajax({
                url: this.options.serverURL + "?json.wrf=?",
                data: this.getParamsFromOptions(),
                dataType:'jsonp',
                success: function(result){
                   var docs = result.response.docs;
       
                   for(var i in docs){
                        var f = {};

                        f.geometry = JSON.parse(docs[i][self.options.geomField]);
                        f.properties = {};
                        for(var p in docs[i]){
                            if(p == self.options.geomField){
                                continue;
                            }
                            f.properties[p] = docs[i][p];
                        }
                       allFeatures.push(f);

                   }

                   
                   for(var j in values){
                    var features = [];
                        for(var k in allFeatures){
                            if(allFeatures[k].properties[self.options.timeField] == values[j]){
                                features.push(allFeatures[k]);

                            }

                        }

                        self._featuresForLayer[values[j]] = features;
                       
                   }
                   console.log(self._featuresForLayer);
                   //override tree node for layer
                   var node = document.getElementById('node_'+self._leaflet_id);
                   node.parentNode.appendChild(self.createNodeHTML());
                   node.parentNode.removeChild(node);
   
                }

            });
          
            
        }

});
/**
 * API factory method for ease creation of Solr features providers.
 * @params {Object} options - Options to initialize the Solr provider
 */
SMC.wfsProvider = function(options) {
    return new SMC.providers.WFSProvider(options);
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="SMC.controls.layerTree.LayerTreeControl.html">LayerTreeControl</a></li><li><a href="SMC.controls.layerTree.LayerTreeLeaf.html">LayerTreeLeaf</a></li><li><a href="SMC.controls.layerTree.LayerTreeNode.html">LayerTreeNode</a></li><li><a href="SMC.layers.aggregation.AggregatingLayer.html">AggregatingLayer</a></li><li><a href="SMC.layers.aggregation.MultiModeLayer.html">MultiModeLayer</a></li><li><a href="SMC.layers.EditableLayer.html">EditableLayer</a></li><li><a href="SMC.layers.Folder.html">Folder</a></li><li><a href="SMC.layers.geometry.CanvasRenderer.html">CanvasRenderer</a></li><li><a href="SMC.layers.geometry.GeometryLayer.html">GeometryLayer</a></li><li><a href="SMC.layers.geometry.SolrGeometryHistoryLayer.html">SolrGeometryHistoryLayer</a></li><li><a href="SMC.layers.geometry.TiledGeometryLayer.html">TiledGeometryLayer</a></li><li><a href="SMC.layers.geometry.WFSGeometryLayer.html">WFSGeometryLayer</a></li><li><a href="SMC.layers.geometry.WFSTiledGeometryLayer.html">WFSTiledGeometryLayer</a></li><li><a href="SMC.layers.history.AggregatingHistoryLayer.html">AggregatingHistoryLayer</a></li><li><a href="SMC.layers.history.DataHistoryLayer.html">DataHistoryLayer</a></li><li><a href="SMC.layers.IsochroneLayer.html">IsochroneLayer</a></li><li><a href="SMC.layers.Layer.html">Layer</a></li><li><a href="SMC.layers.markers.AtmosphereRTMarkerLayer.html">AtmosphereRTMarkerLayer</a></li><li><a href="SMC.layers.markers.MarkerLayer.html">MarkerLayer</a></li><li><a href="SMC.layers.markers.WFSMarkerLayer.html">WFSMarkerLayer</a></li><li><a href="SMC.layers.markers.WFSTMarkerLayer.html">WFSTMarkerLayer</a></li><li><a href="SMC.layers.reloaders.AtmosphereRTReloadTrigger.html">AtmosphereRTReloadTrigger</a></li><li><a href="SMC.layers.reloaders.LayerReloader.html">LayerReloader</a></li><li><a href="SMC.layers.reloaders.ReloadTrigger.html">ReloadTrigger</a></li><li><a href="SMC.layers.reloaders.TimerReloadTrigger.html">TimerReloadTrigger</a></li><li><a href="SMC.layers.stylers.Styler.html">Styler</a></li><li><a href="SMC.layers.TileLayer.html">TileLayer</a></li><li><a href="SMC.layers.WMSLayer.html">WMSLayer</a></li><li><a href="SMC.Map.html">Map</a></li><li><a href="SMC.providers.AtmosphereConnector.html">AtmosphereConnector</a></li><li><a href="SMC.providers.AtmosphereRTFeatureProvider.html">AtmosphereRTFeatureProvider</a></li><li><a href="SMC.providers.FeatureHistory.html">FeatureHistory</a></li><li><a href="SMC.providers.FeatureHistoryProvider.html">FeatureHistoryProvider</a></li><li><a href="SMC.providers.FeaturesProvider.html">FeaturesProvider</a></li><li><a href="SMC.providers.RTFeatureProvider.html">RTFeatureProvider</a></li><li><a href="SMC.providers.SolrHistoryProvider.html">SolrHistoryProvider</a></li><li><a href="SMC.providers.URLFeatureProvider.html">URLFeatureProvider</a></li><li><a href="SMC.providers.WFSProvider.html">WFSProvider</a></li><li><a href="SMC.providers.WFSTProvider.html">WFSTProvider</a></li></ul><h3>Events</h3><ul><li><a href="SMC.layers.geometry.TiledGeometryLayer.html#event:layeradd">layeradd</a></li><li><a href="SMC.layers.geometry.WFSTiledGeometryLayer.html#event:layeradd">layeradd</a></li><li><a href="SMC.layers.reloaders.AtmosphereRTReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.layers.reloaders.ReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.layers.reloaders.TimerReloadTrigger.html#event:reloadTriggered">reloadTriggered</a></li><li><a href="SMC.providers.AtmosphereConnector.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.AtmosphereRTFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.FeatureHistoryProvider.html#event:featureHistoryLoaded">featureHistoryLoaded</a></li><li><a href="SMC.providers.FeaturesProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.RTFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.SolrHistoryProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.URLFeatureProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.WFSProvider.html#event:featuresLoaded">featuresLoaded</a></li><li><a href="SMC.providers.WFSTProvider.html#event:featuresLoaded">featuresLoaded</a></li></ul><h3>Namespaces</h3><ul><li><a href="SMC.html">SMC</a></li><li><a href="SMC.controls.html">controls</a></li><li><a href="SMC.controls.layerTree.html">layerTree</a></li><li><a href="SMC.layers.html">layers</a></li><li><a href="SMC.layers.aggregation.html">aggregation</a></li><li><a href="SMC.layers.geometry.html">geometry</a></li><li><a href="SMC.layers.history.html">history</a></li><li><a href="SMC.layers.markers.html">markers</a></li><li><a href="SMC.layers.reloaders.html">reloaders</a></li><li><a href="SMC.layers.stylers.html">stylers</a></li><li><a href="SMC.providers.html">providers</a></li></ul><h3>Mixins</h3><ul><li><a href="SMC.controls.layerTree.LayerTreeFolder.html">LayerTreeFolder</a></li><li><a href="SMC.LayerLoader.html">LayerLoader</a></li><li><a href="SMC.layers.SingleLayer.html">SingleLayer</a></li><li><a href="SMC.layers.stylers.MapCssStyler.html">MapCssStyler</a></li><li><a href="SMC.layers.stylers.MarkerCssStyler.html">MarkerCssStyler</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Mustache">Mustache</a></li><li><a href="global.html#paper">paper</a></li><li><a href="global.html#PEG">PEG</a></li><li><a href="global.html#rbush">rbush</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Mon Nov 24 2014 08:51:38 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
